<!doctype html><html lang=en><head><title>KQL: Aggregation Functions | curiosities.dev</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo (https://gohugo.io/)"><meta name=description content="Aggregation functions allow you to group and combine data from multiple rows into a summary value. 
 contains the database referenced in this document.
  Use the summarize operator Find the number of events by state.
   State TotalStorms     TEXAS 4,701   KANSAS 3,166   &mldr; &mldr;    StormEvents | summarize TotalStorms = count() by State summarize groups together rows based on the by clause and uses the aggregation function to combine each group into a single row...."><meta property="og:title" content="KQL: Aggregation Functions"><meta property="og:description" content="Aggregation functions allow you to group and combine data from multiple rows into a summary value. 
 contains the database referenced in this document.
  Use the summarize operator Find the number of events by state.
   State TotalStorms     TEXAS 4,701   KANSAS 3,166   &mldr; &mldr;    StormEvents | summarize TotalStorms = count() by State summarize groups together rows based on the by clause and uses the aggregation function to combine each group into a single row...."><meta property="og:type" content="website"><meta property="og:url" content="https://www.curiosities.dev/computer-science/analyzing-datastores/kusto-aggregation-fns/"><meta property="og:site_name" content="curiosities.dev"><link rel=stylesheet type=text/css href=/css/main.min.css><link rel=preload href=/css/all_font_awesome_v5.9.min.min.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=/css/all_font_awesome_v5.9.min.min.css></noscript><link rel="shortcut icon" href=/img/favicon_io/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/img/favicon_io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon_io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon_io/favicon-16x16.png><script async type=text/javascript src=/js/OrganizeCitations.min.js></script><script async type=text/javascript src=/js/HighlightAnchor.min.js></script><script async type=text/javascript src=/js/SummaryPageUtils.min.js></script><link rel=preload href=/css/vs.min.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=/css/vs.min.css></noscript><script defer type=text/javascript src=/js/highlight.min.min.js onload=addURLHighlighter();></script><script defer>const hjlsURLRegex=/https?:\/\/[^\s<]+/g
const hjlsCitationRegex=/&lt;span class=&quot;citation-ref&quot;&gt;&lt;a href=&quot;(.*)&quot;&gt;&lt;\/a&gt;&lt;\/span&gt;/g
function addURLHighlighter(){hljs.addPlugin({"after:highlight":(result)=>{result.value=result.value.replaceAll(hjlsURLRegex,"<a href='$&' target='_blank'>$&</a>");console.log(result.value);result.value=result.value.replaceAll(hjlsCitationRegex,"<span class='citation-ref'><a href='$1'></a></span>");}});hljs.highlightAll();}</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script></head><body><div class=container id=main_div><form action=/search method=get id=globalSearchForm><input type=text id=q name=q title="Search Query">
<input type=submit id=submitButton value=Search></form><nav aria-label=Breadcrumb class=breadcrumb><ul><li><a href=https://www.curiosities.dev/>Home</a></li><li><a href=https://www.curiosities.dev/computer-science/>Computer Science & Software Engineering</a></li><li><a href=https://www.curiosities.dev/computer-science/analyzing-datastores/>Analyzing Data Stores</a></li><li class=active><a href=https://www.curiosities.dev/computer-science/analyzing-datastores/kusto-aggregation-fns/>KQL: Aggregation Functions</a></li></ul></nav><section><header><h1>KQL: Aggregation Functions</h1><p class=meta>Dated May 24, 2025;
last modified on Sat, 24 May 2025</p></header><div id=toc-then-article><aside id=toc><nav id=TableOfContents><ul><li><a href=#use-the-summarize-operator>Use the <code>summarize</code> operator</a></li><li><a href=#visualize-query-results>Visualize query results</a></li><li><a href=#conditionally-count-rows>Conditionally count rows</a></li><li><a href=#group-data-into-bins>Group data into bins</a></li><li><a href=#calculate-the-min-max-avg-and-sum>Calculate the <code>min</code>, <code>max</code>, <code>avg</code>, and <code>sum</code></a></li><li><a href=#calculate-percentages>Calculate percentages</a></li><li><a href=#extract-unique-values>Extract unique values</a></li><li><a href=#bucket-data-by-condition>Bucket data by condition</a></li><li><a href=#perform-aggregations-over-a-sliding-window>Perform aggregations over a sliding window</a></li><li><a href=#references>References</a></li></ul></nav></aside><article id=main-article><p><strong>Aggregation functions</strong> allow you to group and combine data from multiple rows
into a summary value. <span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><div class=comment-holder><div class=comment><p><span class=citation-ref><a href=#help.Samples></a></span>contains the database referenced in this document.</p></div></div><h2 id=use-the-summarize-operator>Use the <code>summarize</code> operator</h2><p>Find the number of events by state.</p><table><thead><tr><th>State</th><th>TotalStorms</th></tr></thead><tbody><tr><td>TEXAS</td><td>4,701</td></tr><tr><td>KANSAS</td><td>3,166</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span> <span style=color:#111>TotalStorms</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>count</span><span style=color:#111>()</span> <span style=color:#00a8c8>by</span> <span style=color:#00a8c8>State</span>
</code></pre></div><p><code>summarize</code> groups together rows based on the <code>by</code> clause and uses the
aggregation function to combine each group into a single row.</p><p><span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><h2 id=visualize-query-results>Visualize query results</h2><p>Show a bar chart for the number of storm events by state for the top 5 states.</p><figure><img src=/img/computer-science/analyzing-datastores/kusto-stormevents-barchart-sample.jpg alt="Top 5 states with highest number of storm events."><figcaption><p>Top 5 states with highest number of storm events.</p></figcaption></figure><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span> <span style=color:#111>TotalStorms</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>count</span><span style=color:#111>()</span> <span style=color:#00a8c8>by</span> <span style=color:#00a8c8>State</span>
<span style=color:#f92672>|</span> <span style=color:#111>top</span> <span style=color:#ae81ff>5</span> <span style=color:#00a8c8>by</span> <span style=color:#111>TotalStorms</span>
<span style=color:#f92672>|</span> <span style=color:#111>render</span> <span style=color:#111>barchart</span>
</code></pre></div><p><span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><h2 id=conditionally-count-rows>Conditionally count rows</h2><p>Query the top 2 states with the greatest number of storms that caused crop
damage.</p><table><thead><tr><th>State</th><th>StormsWithCropDamage</th></tr></thead><tbody><tr><td>IOWA</td><td>359</td></tr><tr><td>NEBRASKA</td><td>201</td></tr></tbody></table><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span> <span style=color:#111>StormsWithCropDamage</span> <span style=color:#f92672>=</span> <span style=color:#111>countif</span><span style=color:#111>(</span><span style=color:#111>DamageCrops</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span> <span style=color:#00a8c8>by</span> <span style=color:#00a8c8>State</span>
<span style=color:#f92672>|</span> <span style=color:#111>top</span> <span style=color:#ae81ff>2</span> <span style=color:#00a8c8>by</span> <span style=color:#111>StormsWithCropDamage</span>
</code></pre></div><p><span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><h2 id=group-data-into-bins>Group data into bins</h2><p>Query the number of storms that caused crop damage for each week in 2007.</p><table><thead><tr><th>StartTime</th><th>EventCount</th></tr></thead><tbody><tr><td>2007-01-01T00:00:00Z</td><td>16</td></tr><tr><td>2007-01-08T00:00:00Z</td><td>20</td></tr></tbody></table><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#00a8c8>where</span> <span style=color:#111>StartTime</span> <span style=color:#00a8c8>between</span> <span style=color:#111>(</span><span style=color:#111>datetime</span><span style=color:#111>(</span><span style=color:#ae81ff>2007</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span><span style=color:#111>)</span> <span style=color:#111>..</span> <span style=color:#111>datetime</span><span style=color:#111>(</span><span style=color:#ae81ff>2007</span><span style=color:#f92672>-</span><span style=color:#ae81ff>12</span><span style=color:#f92672>-</span><span style=color:#ae81ff>31</span><span style=color:#111>))</span> <span style=color:#00a8c8>and</span> <span style=color:#111>DamageCrops</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span> <span style=color:#111>EventCount</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>count</span><span style=color:#111>()</span> <span style=color:#00a8c8>by</span> <span style=color:#111>bin</span><span style=color:#111>(</span><span style=color:#111>StartTime</span><span style=color:#111>,</span> <span style=color:#ae81ff>7</span><span style=color:#111>d</span><span style=color:#111>)</span>
</code></pre></div><div class=comment-holder><div class=comment><p>Makes sense that one should first use <code>where</code> to ensure that the input table for
the <code>bin</code> function only contains the rows of interest. It would be
over-engineering on <code>bin</code>s part to also exclude some rows.</p></div></div><p><code>bin</code> reduces every value to the nearest multiple of the modulus that you supply
and allows <code>summarize</code> to assign the rows to groups.</p><p><span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><h2 id=calculate-the-min-max-avg-and-sum>Calculate the <code>min</code>, <code>max</code>, <code>avg</code>, and <code>sum</code></h2><p>Of the events that caused crop damage, calculate the minimum, maximum, and
average crop damage for each event type and then sort the result by the average
damage.</p><table><thead><tr><th>EventType</th><th>MaxCropDamage</th><th>MinCropDamage</th><th>AvgCropDamage</th></tr></thead><tbody><tr><td>Frost/Freeze</td><td>568,600,000</td><td>3,000</td><td>9,106,087.5954198465</td></tr><tr><td>Wildfire</td><td>21,000,000</td><td>1,000</td><td>7268333.333333333</td></tr><tr><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#00a8c8>where</span> <span style=color:#111>DamageCrops</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span>
    <span style=color:#111>MaxCropDamage</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>max</span><span style=color:#111>(</span><span style=color:#111>DamageCrops</span><span style=color:#111>),</span>
    <span style=color:#111>MinCropDamage</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>min</span><span style=color:#111>(</span><span style=color:#111>DamageCrops</span><span style=color:#111>),</span>
    <span style=color:#111>AvgCropDamage</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>avg</span><span style=color:#111>(</span><span style=color:#111>DamageCrops</span><span style=color:#111>)</span>
    <span style=color:#00a8c8>by</span> <span style=color:#111>EventType</span>
<span style=color:#f92672>|</span> <span style=color:#111>sort</span> <span style=color:#00a8c8>by</span> <span style=color:#111>AvgCropDamage</span> <span style=color:#00a8c8>desc</span>
</code></pre></div><p><code>*if</code> equivalents of <code>min</code>, <code>max</code>, <code>avg</code>, and <code>sum</code>, also exist, e.g.,</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span>
    <span style=color:#111>MaxCropDamage</span> <span style=color:#f92672>=</span> <span style=color:#111>maxif</span><span style=color:#111>(</span><span style=color:#111>DamageCrops</span><span style=color:#111>,</span> <span style=color:#111>DamageCrops</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>),</span>
    <span style=color:#111>MinCropDamage</span> <span style=color:#f92672>=</span> <span style=color:#111>minif</span><span style=color:#111>(</span><span style=color:#111>DamageCrops</span><span style=color:#111>,</span> <span style=color:#111>DamageCrops</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>),</span>
    <span style=color:#111>AvgCropDamage</span> <span style=color:#f92672>=</span> <span style=color:#111>avgif</span><span style=color:#111>(</span><span style=color:#111>DamageCrops</span><span style=color:#111>,</span> <span style=color:#111>DamageCrops</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span>
    <span style=color:#00a8c8>by</span> <span style=color:#111>EventType</span>
<span style=color:#f92672>|</span> <span style=color:#111>sort</span> <span style=color:#00a8c8>by</span> <span style=color:#111>AvgCropDamage</span> <span style=color:#00a8c8>desc</span>
</code></pre></div><p><span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><p>Plot the total number of damaged crops for each week in 2007.</p><figure><img src=/img/computer-science/analyzing-datastores/sum-crop-damage-by-week.png alt="Sum crop damage by week."><figcaption><p>Sum crop damage by week.</p></figcaption></figure><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#00a8c8>where</span> <span style=color:#111>StartTime</span> <span style=color:#00a8c8>between</span> <span style=color:#111>(</span><span style=color:#111>datetime</span><span style=color:#111>(</span><span style=color:#ae81ff>2007</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span><span style=color:#111>)</span> <span style=color:#111>..</span> <span style=color:#111>datetime</span><span style=color:#111>(</span><span style=color:#ae81ff>2007</span><span style=color:#f92672>-</span><span style=color:#ae81ff>12</span><span style=color:#f92672>-</span><span style=color:#ae81ff>31</span><span style=color:#111>))</span> <span style=color:#00a8c8>and</span> <span style=color:#111>DamageCrops</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span> <span style=color:#111>CropDamage</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>sum</span><span style=color:#111>(</span><span style=color:#111>DamageCrops</span><span style=color:#111>)</span> <span style=color:#00a8c8>by</span> <span style=color:#111>bin</span><span style=color:#111>(</span><span style=color:#111>StartTime</span><span style=color:#111>,</span> <span style=color:#ae81ff>7</span><span style=color:#111>d</span><span style=color:#111>)</span>
<span style=color:#f92672>|</span> <span style=color:#111>render</span> <span style=color:#111>timechart</span>
</code></pre></div><p><span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><h2 id=calculate-percentages>Calculate percentages</h2><p>Find the percentage (round to 2 d.p.) of storm events that caused crop damage in
each state. Sort by the number of storms that caused crop damage.</p><table><thead><tr><th>State</th><th>TotalStormsInState</th><th>StormsWithCropDamage</th><th>PercentWithCropDamage</th></tr></thead><tbody><tr><td>IOWA</td><td>2,337</td><td>359</td><td>15.36</td></tr><tr><td>NEBRASKA</td><td>1,766</td><td>201</td><td>11.38</td></tr><tr><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span>
	<span style=color:#111>TotalStormsInState</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>count</span><span style=color:#111>(),</span>
	<span style=color:#111>StormsWithCropDamage</span> <span style=color:#f92672>=</span> <span style=color:#111>countif</span><span style=color:#111>(</span><span style=color:#111>DamageCrops</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span>
	<span style=color:#00a8c8>by</span> <span style=color:#00a8c8>State</span>
<span style=color:#f92672>|</span> <span style=color:#111>extend</span> <span style=color:#111>PercentWithCropDamage</span> <span style=color:#f92672>=</span> <span style=color:#111>round</span><span style=color:#111>(</span><span style=color:#111>todouble</span><span style=color:#111>(</span><span style=color:#111>StormsWithCropDamage</span><span style=color:#111>)</span> <span style=color:#f92672>/</span> <span style=color:#111>TotalStormsInState</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span><span style=color:#111>,</span> <span style=color:#ae81ff>2</span><span style=color:#111>)</span>
<span style=color:#f92672>|</span> <span style=color:#111>sort</span> <span style=color:#00a8c8>by</span> <span style=color:#111>StormsWithCropDamage</span>
</code></pre></div><div class=comment-holder><div class=comment><p>To avoid truncated results due to integer division, convert either the dividend
or the divisor using <code>todouble()</code> or <code>toreal()</code>.</p></div></div><p><span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><p>Compare the number of storms by event type to the total number of storms in the
database. Sort by the percentage.</p><table><thead><tr><th>EventType</th><th>EventCount</th><th>Percentage</th></tr></thead><tbody><tr><td>Thunderstorm Wind</td><td>13,015</td><td>22.034673077574237</td></tr><tr><td>Hail</td><td>12,711</td><td>21.519994582331627</td></tr><tr><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>let</span> <span style=color:#111>TotalStormEvents</span> <span style=color:#f92672>=</span> <span style=color:#111>toscalar</span><span style=color:#111>(</span><span style=color:#111>StormEvents</span> <span style=color:#f92672>|</span> <span style=color:#00a8c8>count</span><span style=color:#111>);</span>
<span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span> <span style=color:#111>EventCount</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>count</span><span style=color:#111>()</span> <span style=color:#00a8c8>by</span> <span style=color:#111>EventType</span>
<span style=color:#f92672>|</span> <span style=color:#111>extend</span> <span style=color:#111>Percentage</span> <span style=color:#f92672>=</span> <span style=color:#111>toreal</span><span style=color:#111>(</span><span style=color:#111>EventCount</span><span style=color:#111>)</span> <span style=color:#f92672>/</span> <span style=color:#111>TotalStormEvents</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>
<span style=color:#f92672>|</span> <span style=color:#111>sort</span> <span style=color:#00a8c8>by</span> <span style=color:#111>Percentage</span>
</code></pre></div><p><code>toscalar</code> is needed because <code>StormEvents | count</code> is a tabular expression that
returns a \(1 \times 1\) table. <span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><div class=comment-holder><div class=comment><p><code>StormEvents | count</code> is equivalent to <code>StormEvents | summarize count()</code>.</p></div></div><h2 id=extract-unique-values>Extract unique values</h2><p>For each state, return an array of storm types that have caused deaths. Sort by
the number of storm types.</p><table><thead><tr><th>State</th><th>StormTypesWithDeaths</th></tr></thead><tbody><tr><td>CALIFORNIA</td><td>[&ldquo;Thunderstorm Wind&rdquo;, &ldquo;High Surf&rdquo;, &ldquo;Cold/Wind Chill&rdquo;, &ldquo;Strong Wind&rdquo;, &ldquo;Rip Current&rdquo;, &ldquo;Heat&rdquo;, &ldquo;Excessive Heat&rdquo;, &ldquo;Wildfire&rdquo;, &ldquo;Dust Storm&rdquo;, &ldquo;Astronomical Low Tide&rdquo;, &ldquo;Dense Fog&rdquo;, &ldquo;Winter Weather&rdquo;]</td></tr><tr><td>TEXAS</td><td>[&ldquo;Flash Flood&rdquo;, &ldquo;Thunderstorm Wind&rdquo;, &ldquo;Tornado&rdquo;, &ldquo;Lightning&rdquo;, &ldquo;Flood&rdquo;, &ldquo;Ice Storm&rdquo;, &ldquo;Winter Weather&rdquo;, &ldquo;Rip Current&rdquo;, &ldquo;Excessive Heat&rdquo;, &ldquo;Dense Fog&rdquo;, &ldquo;Hurricane (Typhoon)&rdquo;, &ldquo;Cold/Wind Chill&rdquo;]</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#00a8c8>where</span> <span style=color:#111>DeathsDirect</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#00a8c8>or</span> <span style=color:#111>DeathsIndirect</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span> <span style=color:#111>StormTypesWithDeaths</span> <span style=color:#f92672>=</span> <span style=color:#111>make_set</span><span style=color:#111>(</span><span style=color:#111>EventType</span><span style=color:#111>)</span> <span style=color:#00a8c8>by</span> <span style=color:#00a8c8>State</span>
<span style=color:#f92672>|</span> <span style=color:#111>sort</span> <span style=color:#00a8c8>by</span> <span style=color:#111>array_length</span><span style=color:#111>(</span><span style=color:#111>StormTypesWithDeaths</span><span style=color:#111>)</span>
</code></pre></div><p><span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><div class=comment-holder><div class="comment open-comment"><p><code>summarize StormTypesWithDeaths = make_set(EventType) by State</code> somehow does
<code>project State, StormTypesWithDeaths</code> for me. What&rsquo;s the name of this
phenomenon?</p></div></div><h2 id=bucket-data-by-condition>Bucket data by condition</h2><p>Group the states based on the number of storm-related injuries sustained by
their residents. Sort alphabetically by state name.</p><table><thead><tr><th>State</th><th>InjuriesCount</th><th>InjuriesBucket</th></tr></thead><tbody><tr><td>ALABAMA</td><td>494</td><td>Large</td></tr><tr><td>ALASKA</td><td>0</td><td>No injuries</td></tr></tbody></table><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span> <span style=color:#111>InjuriesCount</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>sum</span><span style=color:#111>(</span><span style=color:#111>InjuriesDirect</span><span style=color:#111>)</span> <span style=color:#00a8c8>by</span> <span style=color:#00a8c8>State</span>
<span style=color:#f92672>|</span> <span style=color:#111>extend</span> <span style=color:#111>InjuriesBucket</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>case</span><span style=color:#111>(</span>
    <span style=color:#111>InjuriesCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>50</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Large&#39;</span><span style=color:#111>,</span>
    <span style=color:#111>InjuriesCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Medium&#39;</span><span style=color:#111>,</span>
    <span style=color:#111>InjuriesCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Small&#39;</span><span style=color:#111>,</span>
    <span style=color:#d88200>&#39;No injuries&#39;</span><span style=color:#111>)</span>
<span style=color:#f92672>|</span> <span style=color:#111>sort</span> <span style=color:#00a8c8>by</span> <span style=color:#00a8c8>State</span> <span style=color:#00a8c8>asc</span>
</code></pre></div><p><span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><p>Create a pie chart to visualize the proportion of states that experienced storms
resulting in a large, medium, or small number of injuries.</p><figure><img src=/img/computer-science/analyzing-datastores/injuries-bucket-pie-chart.png alt="Injuries bucket pie chart"><figcaption><p>Injuries bucket pie chart</p></figcaption></figure><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span> <span style=color:#111>InjuriesCount</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>sum</span><span style=color:#111>(</span><span style=color:#111>InjuriesDirect</span><span style=color:#111>)</span> <span style=color:#00a8c8>by</span> <span style=color:#00a8c8>State</span>
<span style=color:#f92672>|</span> <span style=color:#111>extend</span> <span style=color:#111>InjuriesBucket</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>case</span><span style=color:#111>(</span>
    <span style=color:#111>InjuriesCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>50</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Large&#39;</span><span style=color:#111>,</span>
    <span style=color:#111>InjuriesCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Medium&#39;</span><span style=color:#111>,</span>
    <span style=color:#111>InjuriesCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Small&#39;</span><span style=color:#111>,</span>
    <span style=color:#d88200>&#39;No injuries&#39;</span><span style=color:#111>)</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span> <span style=color:#111>InjuriesBucketCount</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>count</span><span style=color:#111>()</span> <span style=color:#00a8c8>by</span> <span style=color:#111>InjuriesBucket</span>
<span style=color:#f92672>|</span> <span style=color:#111>render</span> <span style=color:#111>piechart</span>
</code></pre></div><p><span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><h2 id=perform-aggregations-over-a-sliding-window>Perform aggregations over a sliding window</h2><p>For the first 2 weeks of July 2007, calculate the minimum, maximum, and average
property damage of tornados, floods, and wildfires using a sliding window of 7
days. Each record in the result set aggregates the preceding 7 days, and the
results contain a record per day in the analysis period.</p><table><thead><tr><th>TimeStamp</th><th>EventType</th><th>min_DamageProperty</th><th>max_DamageProperty</th><th>avg_DamageProperty</th></tr></thead><tbody><tr><td>2007-07-08T00:00:00Z</td><td>Tornado</td><td>0</td><td>30,000</td><td>6,905</td></tr><tr><td>2007-07-08T00:00:00Z</td><td>Flood</td><td>0</td><td>200,000</td><td>9,261</td></tr><tr><td>2007-07-08T00:00:00Z</td><td>Wildfire</td><td>0</td><td>200,000</td><td>14,033</td></tr><tr><td>2007-07-09T00:00:00Z</td><td>Tornado</td><td>0</td><td>100,000</td><td>14,783</td></tr><tr><td>2007-07-09T00:00:00Z</td><td>Flood</td><td>0</td><td>200,000</td><td>12,529</td></tr><tr><td>2007-07-09T00:00:00Z</td><td>Wildfire</td><td>0</td><td>200,000</td><td>14,033</td></tr><tr><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#111>let</span> <span style=color:#111>windowStart</span> <span style=color:#f92672>=</span> <span style=color:#111>datetime</span><span style=color:#111>(</span><span style=color:#ae81ff>2007</span><span style=color:#f92672>-</span><span style=color:#ae81ff>07</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span><span style=color:#111>);</span>
<span style=color:#111>let</span> <span style=color:#111>windowEnd</span> <span style=color:#f92672>=</span> <span style=color:#111>windowStart</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>13</span><span style=color:#111>d</span><span style=color:#111>;</span>
<span style=color:#111>StormEvents</span>
<span style=color:#f92672>|</span> <span style=color:#00a8c8>where</span> <span style=color:#111>EventType</span> <span style=color:#00a8c8>in</span> <span style=color:#111>(</span><span style=color:#d88200>&#39;Tornado&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Flood&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Wildfire&#39;</span><span style=color:#111>)</span>
<span style=color:#f92672>//</span> <span style=color:#111>Bin</span> <span style=color:#00a8c8>each</span> <span style=color:#111>record</span> <span style=color:#00a8c8>to</span> <span style=color:#111>a</span> <span style=color:#111>single</span> <span style=color:#00a8c8>day</span> <span style=color:#00a8c8>relative</span> <span style=color:#00a8c8>to</span> <span style=color:#111>windowStart</span><span style=color:#111>,</span> <span style=color:#111>e</span><span style=color:#111>.</span><span style=color:#00a8c8>g</span><span style=color:#111>.,</span> <span style=color:#ae81ff>2007</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span><span style=color:#f92672>-</span><span style=color:#ae81ff>02</span> <span style=color:#f92672>*</span> <span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>2007</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span><span style=color:#f92672>-</span><span style=color:#ae81ff>02</span>
<span style=color:#f92672>|</span> <span style=color:#111>extend</span> <span style=color:#111>bin</span> <span style=color:#f92672>=</span> <span style=color:#111>bin_at</span><span style=color:#111>(</span><span style=color:#111>startofday</span><span style=color:#111>(</span><span style=color:#111>StartTime</span><span style=color:#111>),</span> <span style=color:#ae81ff>1</span><span style=color:#111>d</span><span style=color:#111>,</span> <span style=color:#111>windowStart</span><span style=color:#111>)</span>
<span style=color:#f92672>//</span> <span style=color:#00a8c8>Add</span> <span style=color:#ae81ff>7</span><span style=color:#111>d</span> <span style=color:#00a8c8>to</span> <span style=color:#00a8c8>set</span> <span style=color:#111>the</span> <span style=color:#00a8c8>end</span> <span style=color:#00a8c8>of</span> <span style=color:#111>the</span> <span style=color:#111>range</span> <span style=color:#00a8c8>for</span> <span style=color:#00a8c8>each</span> <span style=color:#111>record</span><span style=color:#111>;</span> <span style=color:#111>clamp</span> <span style=color:#00a8c8>values</span> <span style=color:#111>outside</span> <span style=color:#111>[</span><span style=color:#111>windowStart</span><span style=color:#111>,</span> <span style=color:#111>windowEnd</span><span style=color:#111>]</span>
<span style=color:#f92672>|</span> <span style=color:#111>extend</span> <span style=color:#111>endRange</span> <span style=color:#f92672>=</span> <span style=color:#111>iff</span><span style=color:#111>(</span><span style=color:#111>bin</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>7</span><span style=color:#111>d</span> <span style=color:#f92672>&gt;</span> <span style=color:#111>windowEnd</span><span style=color:#111>,</span> <span style=color:#111>windowEnd</span><span style=color:#111>,</span>
                        <span style=color:#111>iff</span><span style=color:#111>(</span><span style=color:#111>bin</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>6</span><span style=color:#111>d</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>windowStart</span><span style=color:#111>,</span> <span style=color:#111>windowStart</span><span style=color:#111>,</span>
                            <span style=color:#111>iff</span><span style=color:#111>(</span><span style=color:#111>bin</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>6</span><span style=color:#111>d</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>bin</span><span style=color:#111>,</span> <span style=color:#111>bin</span><span style=color:#111>,</span> <span style=color:#111>bin</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>6</span><span style=color:#111>d</span><span style=color:#111>)))</span>
<span style=color:#f92672>//</span> <span style=color:#00a8c8>Create</span> <span style=color:#111>an</span> <span style=color:#111>array</span> <span style=color:#00a8c8>of</span> <span style=color:#ae81ff>7</span> <span style=color:#111>days</span> <span style=color:#00a8c8>for</span> <span style=color:#00a8c8>each</span> <span style=color:#111>record</span><span style=color:#111>,</span> <span style=color:#111>starting</span> <span style=color:#00a8c8>from</span> <span style=color:#111>the</span> <span style=color:#00a8c8>current</span> <span style=color:#00a8c8>day</span> <span style=color:#00a8c8>of</span> <span style=color:#111>the</span> <span style=color:#111>record</span>
<span style=color:#f92672>|</span> <span style=color:#111>extend</span> <span style=color:#111>range</span> <span style=color:#f92672>=</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#111>bin</span><span style=color:#111>,</span> <span style=color:#111>endRange</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>d</span><span style=color:#111>)</span>
<span style=color:#f92672>//</span> <span style=color:#111>Expand</span> <span style=color:#111>the</span> <span style=color:#111>array</span> <span style=color:#00a8c8>to</span> <span style=color:#111>duplicate</span> <span style=color:#00a8c8>each</span> <span style=color:#111>record</span> <span style=color:#00a8c8>to</span> <span style=color:#ae81ff>7</span> <span style=color:#111>records</span> <span style=color:#00a8c8>with</span> <span style=color:#111>one</span><span style=color:#f92672>-</span><span style=color:#00a8c8>day</span> <span style=color:#111>intervals</span> <span style=color:#00a8c8>between</span> <span style=color:#111>them</span>
<span style=color:#f92672>|</span> <span style=color:#111>mv</span><span style=color:#f92672>-</span><span style=color:#111>expand</span> <span style=color:#111>range</span> <span style=color:#00a8c8>to</span> <span style=color:#111>typeof</span><span style=color:#111>(</span><span style=color:#111>datetime</span><span style=color:#111>)</span>
<span style=color:#f92672>//</span> <span style=color:#111>Perform</span> <span style=color:#111>the</span> <span style=color:#111>aggregations</span> <span style=color:#00a8c8>for</span> <span style=color:#00a8c8>each</span> <span style=color:#00a8c8>day</span><span style=color:#111>.</span> <span style=color:#111>Due</span> <span style=color:#00a8c8>to</span> <span style=color:#111>the</span> <span style=color:#00a8c8>prior</span> <span style=color:#111>expansion</span><span style=color:#111>,</span> <span style=color:#111>this</span> <span style=color:#111>summarizes</span> <span style=color:#111>the</span> <span style=color:#111>previous</span> <span style=color:#ae81ff>7</span> <span style=color:#111>days</span>
<span style=color:#f92672>|</span> <span style=color:#111>summarize</span>
    <span style=color:#00a8c8>min</span><span style=color:#111>(</span><span style=color:#111>DamageProperty</span><span style=color:#111>),</span> <span style=color:#00a8c8>max</span><span style=color:#111>(</span><span style=color:#111>DamageProperty</span><span style=color:#111>),</span> <span style=color:#111>round</span><span style=color:#111>(</span><span style=color:#00a8c8>avg</span><span style=color:#111>(</span><span style=color:#111>DamageProperty</span><span style=color:#111>))</span>
    <span style=color:#00a8c8>by</span> <span style=color:#00a8c8>TimeStamp</span> <span style=color:#f92672>=</span> <span style=color:#111>bin_at</span><span style=color:#111>(</span><span style=color:#111>range</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>d</span><span style=color:#111>,</span> <span style=color:#111>windowStart</span><span style=color:#111>),</span> <span style=color:#111>EventType</span>
<span style=color:#f92672>|</span> <span style=color:#00a8c8>where</span> <span style=color:#00a8c8>TimeStamp</span> <span style=color:#f92672>&gt;=</span> <span style=color:#111>windowStart</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>7</span><span style=color:#111>d</span><span style=color:#111>;</span>
</code></pre></div><p><span class=citation-ref><a href=#AggregationFnsKQL></a></span></p><div class=comment-holder><div class="comment open-comment"><p>Still need to revisit this query. A lot going on.</p></div></div><h2 id=references>References</h2><ol><li><div class=citation citation-icon-class="fas fa-fw fa-globe" cited-by-count is-main><cite id=help.Samples>help.Samples | Azure Data Explorer<i>.</i></cite>
<a href=https://dataexplorer.azure.com/clusters/help/databases/Samples target=_blank rel=noopener><img src="https://www.google.com/s2/favicons?domain=dataexplorer.azure.com" loading=lazy aria-hidden=true width=16 height=16>
<i>dataexplorer.azure.com</i> <i class="fas fa-fw fa-external-link-alt" aria-hidden=true></i></a>.
<i class="fas fa-fw fa-globe" aria-hidden=true></i>Accessed May 24, 2025.</div></li><li><div class=citation citation-icon-class="fas fa-fw fa-globe" cited-by-count is-main><cite id=AggregationFnsKQL>Tutorial: Use aggregation functions in Kusto Query Language - Kusto | Microsoft Learn<i>.</i></cite>
<a href="https://learn.microsoft.com/en-us/kusto/query/tutorials/use-aggregation-functions?view=azure-data-explorer" target=_blank rel=noopener><img src="https://www.google.com/s2/favicons?domain=learn.microsoft.com" loading=lazy aria-hidden=true width=16 height=16>
<i>learn.microsoft.com</i> <i class="fas fa-fw fa-external-link-alt" aria-hidden=true></i></a>.
Aug 12, 2024.
<i class="fas fa-fw fa-globe" aria-hidden=true></i>Accessed May 24, 2025.</div></li></ol></article><div style=font-size:smaller><aside id=domains-holder style="margin:0 0 2%">Cited Domains:
<a href=/domains/dataexplorer.azure.com style="margin:0 2px"><img src="https://www.google.com/s2/favicons?domain=dataexplorer.azure.com" loading=lazy aria-hidden=true width=16 height=16>
dataexplorer.azure.com</a>
<a href=/domains/learn.microsoft.com style="margin:0 2px"><img src="https://www.google.com/s2/favicons?domain=learn.microsoft.com" loading=lazy aria-hidden=true width=16 height=16>
learn.microsoft.com</a></aside></div></div><footer><a href=https://www.curiosities.dev/computer-science/analyzing-datastores/kusto-common-operators/>&#171; KQL: Common Operators</a></footer></section></div><footer><a href=/about>About</a>
<a href=/search>Search</a></footer></body></html>