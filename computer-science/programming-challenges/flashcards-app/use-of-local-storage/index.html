<!doctype html><html lang=en><head><title>Use of Local Storage | curiosities.dev</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo (https://gohugo.io/)"><meta name=description content="Back when I wrote this, the motivation for using localStorage was to reduce the trips to the server so that the app is usable offline. However, with two data stores (localStorage and the server), the former has a possibility of going stale. What usage is correct and how can we avoid stale data?
localStorage['session_info'] getAccountInfo: () => AuthenticateUser | null fetches the session_info entry and JSON.parses it into an AuthenticateUser. This is a possible failure point because the parsed JSON cannot be trusted to be a valid AuthenticateUser instance...."><link rel=stylesheet type=text/css href=/css/main.min.css><link rel=preload href=/css/all_font_awesome_v5.9.min.min.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=/css/all_font_awesome_v5.9.min.min.css></noscript><link rel="shortcut icon" href=/img/favicon_io/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/img/favicon_io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon_io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon_io/favicon-16x16.png><script async type=text/javascript src=/js/OrganizeCitations.min.js></script><script async type=text/javascript src=/js/HighlightAnchor.min.js></script><script async type=text/javascript src=/js/SummaryPageUtils.min.js></script><link rel=preload href=/css/vs.min.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=/css/vs.min.css></noscript><script defer type=text/javascript src=/js/highlight.min.min.js onload=addURLHighlighter();></script><script defer>const hjlsURLRegex=/https?:\/\/[^\s<]+/g
const hjlsCitationRegex=/&lt;span class=&quot;citation-ref&quot;&gt;&lt;a href=&quot;(.*)&quot;&gt;&lt;\/a&gt;&lt;\/span&gt;/g
function addURLHighlighter(){hljs.addPlugin({"after:highlight":(result)=>{result.value=result.value.replaceAll(hjlsURLRegex,"<a href='$&' target='_blank'>$&</a>");console.log(result.value);result.value=result.value.replaceAll(hjlsCitationRegex,"<span class='citation-ref'><a href='$1'></a></span>");}});hljs.highlightAll();}</script></head><body><div class=container id=main_div><form action=/search method=get id=globalSearchForm><input type=text id=q name=q title="Search Query">
<input type=submit id=submitButton value=Search></form><nav aria-label=Breadcrumb class=breadcrumb><ul><li><a href=https://www.curiosities.dev/>Home</a></li><li><a href=https://www.curiosities.dev/computer-science/>Computer Science & Software Engineering</a></li><li><a href=https://www.curiosities.dev/computer-science/programming-challenges/>Programming Challenges</a></li><li><a href=https://www.curiosities.dev/computer-science/programming-challenges/flashcards-app/>Flashcards App</a></li><li class=active><a href=https://www.curiosities.dev/computer-science/programming-challenges/flashcards-app/use-of-local-storage/>Use of Local Storage</a></li></ul></nav><section><header><h1>Use of Local Storage</h1><p class=meta>Dated Apr 18, 2024;
last modified on Thu, 18 Apr 2024</p></header><div id=toc-then-article><aside id=toc><nav id=TableOfContents><ul><li><a href=#localstoragesession_info><code>localStorage['session_info']</code></a></li><li><a href=#localstoragemetadata><code>localStorage['metadata']</code></a></li><li><a href=#localstorageminicards><code>localStorage['minicards]</code></a></li><li><a href=#localstoragecardid><code>localStorage[cardId]</code></a></li><li><a href=#localstorageclear><code>localStorage.clear()</code></a></li><li><a href=#references>References</a></li></ul></nav></aside><article id=main-article><p>Back when I wrote this, the motivation for using <code>localStorage</code> was to
reduce the trips to the server so that the app is usable offline.
However, with two data stores (<code>localStorage</code> and the server), the
former has a possibility of going stale. What usage is correct and how
can we avoid stale data?</p><h2 id=localstoragesession_info><code>localStorage['session_info']</code></h2><p><code>getAccountInfo: () => AuthenticateUser | null</code> fetches the
<code>session_info</code> entry and <code>JSON.parse</code>s it into an <code>AuthenticateUser</code>.
This is a possible failure point because the parsed JSON cannot be
trusted to be a valid <code>AuthenticateUser</code> instance. This bit should be
removed.</p><p>There&rsquo;s no write location for <code>session_info</code> either, so this
<code>getAccountInfo()</code> returns <code>null</code>, except for users on a very old
version of the site where we&rsquo;d write into <code>session_info</code>.</p><h2 id=localstoragemetadata><code>localStorage['metadata']</code></h2><p>Set after the <code>POST</code> message to <code>/read-metadata</code>. Contains a
JSON-serialization of <code>IMetadata[]</code>, which is usually a single item
array.</p><p>One write comes from <code>setupInitializationData</code>, which is called after
the <code>POST</code> message to <code>/login</code> succeeds. Another write comes from
<code>refreshMetadata()</code>, which is called from <code>initializeAccountPage</code> and
<code>initializeHomepage</code>.</p><p>There is no read of this entry. It can be safely removed.</p><h2 id=localstorageminicards><code>localStorage['minicards]</code></h2><p>Looking at the read references first is more useful. There are no reads
in the app, and so there&rsquo;s no need to analyze write locations.</p><h2 id=localstoragecardid><code>localStorage[cardId]</code></h2><p><code>CardsManager.findCard</code> looks for the card in <code>localStorage</code> before
requesting one from the server. If the card ends up being requested from
the server, the method persists the server result in <code>localStorage</code> in
anticipation of the next query.</p><p><code>/browse</code>&rsquo;s <code>copyCardToOwnCollection</code> writes to <code>localStorage</code> once the
<code>/duplicate-card</code> <code>POST</code> message succeeds.</p><p><code>CardsManager.updateCard</code> overwrites the old entry with the input
<code>card</code>. <code>CardsManager.findCard</code> writes to <code>localStorage</code> on fetching the
card from the server.</p><p>Stale card entries could come from the user interacting with the app on
a different browser/machine. The client app does not subscribe to
updates from the server. While <code>sessionStorage</code> is cleared after the
page session is done, <code>localStorage</code> has no expiry date. <span class=citation-ref><a href=#localStorageMDN></a></span>This makes the likelihood of the cards being stale
even more likely.</p><div class=comment-holder><div class=comment><p>At first, it seemed that making <code>CardsManager</code> a web component and
clearing the <code>localStorage</code> in the disconnected callback was a use-case
for web components, but turns out the platform already has
<code>sessionStorage</code> for that!</p></div></div><p>Using <code>sessionStorage</code> for the cards seems like it&rsquo;d be less
stale-prone.</p><h2 id=localstorageclear><code>localStorage.clear()</code></h2><p>On a user confirming that they wish to delete their account, we send a
<code>POST</code> message to <code>/account/delete-account</code>, and on any valid response,
clear <code>localStorage</code> and set <code>window.location.href = "/"</code>. We do a
similar thing after a successful <code>POST</code> message to <code>/logout</code>.</p><p>So even though <code>localStorage</code> is forever, we do clear it on logout and
account deletion.</p><h2 id=references>References</h2><ol><li><div class=citation citation-icon-class="fas fa-fw fa-globe" cited-by-count is-main><cite id=localStorageMDN>Window: localStorage property - Web APIs | MDN<i>.</i></cite>
<a href=https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage target=_blank rel=noopener><img src="https://www.google.com/s2/favicons?domain=developer.mozilla.org" loading=lazy aria-hidden=true width=16 height=16>
<i>developer.mozilla.org</i> <i class="fas fa-fw fa-external-link-alt" aria-hidden=true></i></a>.
<i class="fas fa-fw fa-globe" aria-hidden=true></i>Accessed Apr 18, 2024.</div></li></ol></article><div style=font-size:smaller><aside id=domains-holder style="margin:0 0 2%">Cited Domains:
<a href=/domains/developer.mozilla.org style="margin:0 2px"><img src="https://www.google.com/s2/favicons?domain=developer.mozilla.org" loading=lazy aria-hidden=true width=16 height=16>
developer.mozilla.org</a></aside></div></div><footer><a href=https://www.curiosities.dev/computer-science/programming-challenges/flashcards-app/hosting/>&#171; Hosting the Flashcards App</a>
<a href=https://www.curiosities.dev/computer-science/programming-challenges/flashcards-app/client-server-interface/>Client/Server Interface &#187;</a></footer></section></div><footer><a href=mailto:d.chege711@gmail.com>Email</a>
<a href=/about>About</a>
<a href=/search>Search</a></footer></body></html>